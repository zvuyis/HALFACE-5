<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; }
        canvas { position: absolute; left: 0; top: 0; width: 100vw; height: 100vh; object-fit: cover; }
        video { display: none; } /* אנחנו לא צריכים לראות את הוידאו המקורי, רק את הקנבס */
        #ui { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 15px; z-index: 100; }
        button { padding: 15px 25px; border-radius: 30px; border: 2px solid #0f0; background: rgba(0,0,0,0.8); color: #0f0; font-weight: bold; font-size: 16px; }
    </style>
</head>
<body>
    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas"></canvas>
    <div id="ui">
        <button onclick="mirrorSide='left'">שכפל שמאל</button>
        <button onclick="mirrorSide='right'">שכפל ימין</button>
    </div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let mirrorSide = 'left';

async function setup() {
    await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
    await faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/');
    
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
    video.srcObject = stream;

    video.onloadedmetadata = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        detect();
    };
}

async function detect() {
    setInterval(async () => {
        const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (detections.length > 0) {
            const landmarks = detections[0].landmarks;
            const nose = landmarks.getNose();
            const nx = nose[0].x; // מיקום האף (ציר ה-X)
            
            const vW = video.videoWidth;
            const vH = video.videoHeight;

            if (mirrorSide === 'left') {
                // 1. מצייר את חצי הפנים השמאלי (מהקצה עד האף)
                ctx.drawImage(video, 0, 0, nx, vH, 0, 0, nx, vH);
                
                // 2. משקף את אותו החצי לצד ימין
                ctx.save();
                ctx.translate(nx * 2, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(video, 0, 0, nx, vH, 0, 0, nx, vH);
                ctx.restore();
            } else {
                // 1. מצייר את חצי הפנים הימני (מהאף עד הקצה)
                const rightPartW = vW - nx;
                ctx.drawImage(video, nx, 0, rightPartW, vH, nx, 0, rightPartW, vH);
                
                // 2. משקף את אותו החצי לצד שמאל
                ctx.save();
                ctx.translate(nx * 2, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(video, nx, 0, rightPartW, vH, nx, 0, rightPartW, vH);
                ctx.restore();
            }

            // קו ירוק דק על ציר הסימטריה
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(nx, 0); ctx.lineTo(nx, canvas.height);
            ctx.stroke();
        }
    }, 40); // 25 פריימים בשנייה לעבודה חלקה
}

document.body.addEventListener('click', () => video.play());
setup();
</script>
</body>
</html>
