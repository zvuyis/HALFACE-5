<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dynamic Symmetry Axis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.js"></script>
    <script src="https://unpkg.com/ml5@1/dist/ml5.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; }
        #status { position: absolute; top: 20px; width: 100%; text-align: center; color: white; font-family: sans-serif; z-index: 10; }
    </style>
</head>
<body>
    <div id="status">טוען מצלמה... (גע במסך)</div>
<script>
let capture;
let faceMesh;
let face;
let smoothNoseX = 0; // לריכוך תנועת הקו

function preload() {
    // טוען את מודל זיהוי הפנים
    faceMesh = ml5.faceMesh({ maxFaces: 1, flipped: false });
}

function setup() {
    createCanvas(windowWidth, windowHeight);
    let constraints = {
        video: { facingMode: "user", width: { ideal: 640 }, height: { ideal: 480 } },
        audio: false
    };
    capture = createCapture(constraints, () => {
        document.getElementById('status').innerText = "מחפש פנים...";
    });
    capture.size(640, 480);
    capture.elt.setAttribute('playsinline', ''); // חובה לאייפון
    capture.hide();

    // מתחיל לזהות פנים מהמצלמה
    faceMesh.detectStart(capture, (results) => {
        if (results && results.length > 0) {
            face = results[0];
            document.getElementById('status').style.display = 'none'; // מסתיר את ההודעה
        } else {
            face = null;
            document.getElementById('status').style.display = 'block';
            document.getElementById('status').innerText = "לא נמצאו פנים";
        }
    });
}

function draw() {
    // מציג את תמונת המצלמה המלאה
    // שומר על יחס גובה-רוחב וממלא את גובה המסך
    let aspectRatio = capture.width / capture.height;
    let imgWidth = width;
    let imgHeight = height;

    if (imgWidth / imgHeight > aspectRatio) { // אם המסך רחב יותר מהוידאו
        imgWidth = imgHeight * aspectRatio;
    } else { // אם המסך גבוה יותר מהוידאו
        imgHeight = imgWidth / aspectRatio;
    }

    let x = (width - imgWidth) / 2;
    let y = (height - imgHeight) / 2;

    image(capture, x, y, imgWidth, imgHeight);

    // אם נמצאו פנים, מצייר את הקו
    if (face && face.keypoints) {
        // נקודה 1 היא גשר האף
        let nose = face.keypoints[1];
        
        // ממיר את קואורדינטות ה-AI (640x480) לקואורדינטות המסך
        let scaledNoseX = map(nose.x, 0, capture.width, x, x + imgWidth);
        
        // מרכך את תנועת הקו כדי שלא יקפוץ
        smoothNoseX = lerp(smoothNoseX, scaledNoseX, 0.2);

        // מצייר קו ירוק על ציר האף
        stroke(0, 255, 0); // ירוק
        strokeWeight(4);   // עבה
        line(smoothNoseX, 0, smoothNoseX, height);
    }
}

// חובה באייפון - מפעיל את הוידאו במגע ראשון
function touchStarted() {
    if (capture && capture.elt) {
        capture.elt.play();
    }
}

function windowResized() {
    resizeCanvas(windowWidth, windowHeight);
}
</script>
</body>
</html>
